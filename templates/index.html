<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>発想標語に対応する演奏見本システム</title>
    
    <!-- ============================= -->
    <!-- CSS -->
    <!-- ============================= -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- ============================= -->
    <!-- ライブラリ読み込み -->
    <!-- ============================= -->
    <!-- 楽譜描画ライブラリ(abcjs) -->
    <script src="{{ url_for('static', filename='js/abcjs-basic-min.js') }}"></script>

    <!-- アプリケーションスクリプト(main.js) -->
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>発想標語に対応する演奏見本システム</h1>
        </header>

        <div class="main-content">
            <!-- ============================================= -->
            <!-- 左パネル：操作エリア -->
            <!-- ============================================= -->
            <div class="panel left-panel">
                
                <!-- 1: ファイル読み込み -->
                <div class="card">
                    <h2>1. ファイル読み込み</h2>
                    <form id="upload-form">
                        <label for="xml-file">楽譜 (MusicXML):</label>
                        <input type="file" id="xml-file" name="xml-file" accept=".xml,.musicxml" required>
                        
                        <label for="midi-file">演奏データ (MIDI):</label>
                        <input type="file" id="midi-file" name="midi-file" accept=".mid,.midi" required>
                        
                        <button type="submit">読み込み開始</button>
                    </form>
                </div>

                <!-- 2: パート選択 -->
                <div class="card">
                    <h2>2. パート選択</h2>
                    <select id="part-selector" disabled>
                        <option>先にファイルを読み込んでください</option>
                    </select>
                </div>

                <!-- 3: フレーズ設定 -->
                <div class="card">
                    <h2>3. フレーズ設定</h2>
                    <p>楽譜上のフレーズ<strong>開始 → 終了 → 頂点</strong>となる音符を順番にクリックしてください。</p>
                    
                    <div id="phrase-info">
                        <p>開始: <span id="start-note-info">未選択</span></p>
                        <p>頂点: <span id="peak-note-info">未選択</span></p>
                        <p>終了: <span id="end-note-info">未選択</span></p>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button id="reset-selection-btn">選択範囲をリセット</button>
                        
                        <div class="history-controls">
                             <div class="action-button-container">
                                <button id="undo-btn" disabled>一つ前に戻る</button>
                                <div id="undo-spinner" class="loader hidden"></div>
                            </div>
                             <div class="action-button-container">
                                <button id="redo-btn" disabled>やり直す</button>
                                <div id="redo-spinner" class="loader hidden"></div>
                            </div>
                        </div>

                        <div class="action-button-container">
                            <button id="reset-midi-btn" style="background-color: #dc3545;" disabled>すべての加工をリセット</button>
                            <div id="reset-spinner" class="loader hidden"></div>
                        </div>
                    </div>

                </div>

                <!-- 4: 表現プリセット -->
                <div class="card">
                    <div class="card-header">
                        <h2>4. 表現プリセット</h2>
                        <button id="toggle-params-btn" class="test-mode-btn">パラメータ調整</button>
                    </div>
                    <label for="tempo-preset">発想標語プリセット:</label>
                    <select id="tempo-preset">
                        {% for name, data in presets.tempo_expressions.items() %}
                        <option value="{{ name }}">
                            {{ name }}
                            {% if data.meaning and data.meaning != "" %}
                                ：{{ data.meaning }}
                            {% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    
                    <div id="parameter-editor" class="hidden">
                        <p class="editor-title">テスト用パラメータ調整</p>
                        <div class="param-group">
                            <label for="param-base-cc2">基本CC#2増減 (base_cc2)</label>
                            <input type="number" id="param-base-cc2" class="param-input">
                        </div>
                        <div class="param-group">
                            <label for="param-peak-cc2">頂点CC#2増減 (peak_cc2)</label>
                            <input type="number" id="param-peak-cc2" class="param-input">
                        </div>
                        <div class="param-group">
                            <label for="param-onset-ms">発音タイミング (onset_ms)</label>
                            <input type="number" id="param-onset-ms" class="param-input">
                        </div>
                    </div>
                </div>

                <!-- 5: 適用と再生 -->
                <div class="card">
                    <h2>5. 適用と再生</h2>
                    <p>設定が完了したら、下のボタンを押してください。</p>
                    
                    <div class="action-button-container" style="margin-bottom: 10px;">
                        <button id="apply-to-score-btn" disabled>楽譜へ反映</button>
                    </div>
                    
                    <p style="font-size: 0.9em; color: #555;">楽譜に反映後、下のボタンで音源を生成します。</p>

                    <div class="action-button-container">
                        <button id="generate-audio-btn" class="generate-btn" disabled>音源を生成</button>
                        <div id="loading-spinner" class="loader hidden"></div>
                    </div>
                    
                    <!-- 進捗表示エリア -->
                    <div id="progress-area" class="hidden" style="margin-top: 10px; background-color: #f0f0f0; padding: 8px; border-radius: 4px; text-align: center;">
                        <span id="progress-text"></span>
                        <div id="progress-bar-container" style="background-color: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 5px;">
                            <div id="progress-bar" style="width: 0%; height: 10px; background-color: #007bff; transition: width 0.3s ease;"></div>
                        </div>
                    </div>

                    <!-- 🎧 聴き比べボタン群 -->
                    <div id="compare-container" style="margin-top: 15px; display:none;">
                        <h3>🎧 聴き比べ</h3>
                        <p style="font-size: 0.9em; color: #555;">加工前後・単一パート／全体を聴き比べできます。</p>
                        <div class="compare-block">
                            <button onclick="playWAV('original_single', this)">🎵 単一パート（元）再生</button>
                            <button onclick="playWAV('processed_single', this)">🎶 単一パート（加工後）再生</button>
                        </div>
                        <div class="compare-block">
                            <button onclick="playWAV('original_full', this)">🎵 全体（元）再生</button>
                            <button onclick="playWAV('processed_full', this)">🎶 全体（加工後）再生</button>
                        </div>
                        <div style="margin-top: 10px;">
                            <button onclick="stopWAV()">⏹ 停止</button>
                        </div>
                    </div>
                </div>

                <!-- 6: 保存 -->
                <div class="card">
                    <h2>6. 保存</h2>
                    <p>加工が完了すると、MIDIファイルを保存できます。</p>
                    <!-- 保存ボタンのエリア（最初は非表示） -->
                    <div id="save-area" style="display:none;">
                        <button id="save-midi-btn" class="save-btn" style="width: 100%;">💾 加工後MIDIを保存</button> 
                    </div>
                </div>
            </div>

            <!-- ============================================= -->
            <!-- 右パネル: 楽譜表示エリア -->
            <!-- ============================================= -->
            <div class="panel right-panel">
                <div id="status-message">
                    ここに楽譜が表示されます。左のエリアからファイルを読み込んでください。
                </div>
                <!-- abcjsによる楽譜描画ターゲット -->
                <div id="score-display"></div>
                <!-- 楽譜描画に関するステータス表示エリア -->
                <div id="abc-status" style="margin-top: 10px; color: gray;"></div>
            </div>
        </div>
    </div>

    <!-- Flaskから渡されたプリセットをJavaScriptで扱えるようにする -->
    <script>
        const presetsJsonString = '{{ presets | tojson | safe }}';
        const PRESETS = JSON.parse(presetsJsonString);
    </script>
</body>
</html>