<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>発想標語に対応する演奏見本システム</title>
    
    <!-- ============================= -->
    <!-- CSS -->
    <!-- ============================= -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- ============================= -->
    <!-- ライブラリ読み込み -->
    <!-- ============================= -->
    <!-- 楽譜描画ライブラリ(abcjs) -->
    <script src="{{ url_for('static', filename='js/abcjs-basic-min.js') }}"></script>

    <!-- アプリケーションスクリプト(main.js) -->
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>発想標語に対応する演奏見本システム</h1>
        </header>

        <div class="main-content">
            <!-- ============================================= -->
            <!-- 左パネル：操作エリア -->
            <!-- ============================================= -->
            <div class="panel left-panel">
                
                <!-- 1: ファイル読み込み -->
                <div class="card">
                    <h2>1. ファイル読み込み</h2>
                    <form id="upload-form">
                        <label for="xml-file">楽譜 (MusicXML):</label>
                        <input type="file" id="xml-file" name="xml-file" accept=".xml,.musicxml" required>
                        
                        <label for="midi-file">演奏データ (MIDI):</label>
                        <input type="file" id="midi-file" name="midi-file" accept=".mid,.midi" required>
                        
                        <button type="submit">読み込み開始</button>
                    </form>
                </div>

                <!-- 2: パート選択 -->
                <div class="card">
                    <h2>2. パート選択</h2>
                    <select id="part-selector" disabled>
                        <option>先にファイルを読み込んでください</option>
                    </select>
                </div>

                <!-- 3: フレーズ設定 -->
                <div class="card">
                    <h2>3. フレーズ設定</h2>
                    <p>楽譜上のフレーズ<strong>開始 → 終了 → 頂点</strong>となる音符を順番にクリックしてください。</p>
                    
                    <div id="phrase-info">
                        <p>開始: <span id="start-note-info">未選択</span></p>
                        <p>頂点: <span id="peak-note-info">未選択</span></p>
                        <p>終了: <span id="end-note-info">未選択</span></p>
                    </div>

                    <button id="reset-selection-btn">選択範囲をリセット</button>
                    
                    <!-- ★★★ ここに「すべての加工をリセット」ボタンを追加 ★★★ -->
                    <button id="reset-midi-btn" style="background-color: #dc3545; margin-top: 10px;">すべての加工をリセット</button>
                </div>

                <!-- 4: 表現プリセット -->
                <div class="card">
                    <h2>4. 表現プリセット</h2>
                    <label for="tempo-preset">発想標語プリセット:</label>
                    <select id="tempo-preset">
                        {% for name, params in presets.tempo_expressions.items() %}
                        <option value="{{ name }}">{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- 5: 適用と再生 -->
                <div class="card">
                    <h2>5. 適用と再生</h2>
                    <p>設定が完了したら、下のボタンを押してください。</p>
                    <p style="font-size: 0.9em; color: #555;">MIDIの加工ができると下の聴き比べエリアが緑に光ります</p>
                    <button id="apply-btn" disabled>適用して加工後MIDIを生成</button>
                    
                    <!-- 🎧 聴き比べボタン群 -->
                    <div id="compare-container" style="margin-top: 15px; display:none;">
                        <h3>🎧 聴き比べ</h3>
                        <p style="font-size: 0.9em; color: #555;">加工前後・単一パート／全体を聴き比べできます。</p>

                        <div class="compare-block">
                            <button onclick="playWAV('original_single', this)">🎵 単一パート（元）再生</button>
                            <button onclick="playWAV('processed_single', this)">🎶 単一パート（加工後）再生</button>
                        </div>

                        <div class="compare-block">
                            <button onclick="playWAV('original_full', this)">🎵 全体（元）再生</button>
                            <button onclick="playWAV('processed_full', this)">🎶 全体（加工後）再生</button>
                        </div>

                        <div style="margin-top: 10px;">
                            <button onclick="stopWAV()">⏹ 停止</button>
                        </div>
                    </div>
                </div>

                <!-- 6: 保存 -->
                <div class="card">
                    <h2>6. 保存</h2>
                    <p>加工が完了すると、MIDIファイルを保存できます。</p>
                    
                    <!-- 保存ボタンのエリア（最初は非表示） -->
                    <div id="save-area" style="display:none;">
                        <button id="save-midi-btn" class="save-btn" style="width: 100%;">💾 加工後MIDIを保存</button> 
                    </div>
                </div>
            </div>

            <!-- ============================================= -->
            <!-- 右パネル: 楽譜表示エリア -->
            <!-- ============================================= -->
            <div class="panel right-panel">
                <div id="status-message">
                    ここに楽譜が表示されます。左のエリアからファイルを読み込んでください。
                </div>

                <!-- abcjsによる楽譜描画ターゲット -->
                <div id="score-display"></div>

                <!-- 楽譜描画に関するステータス表示エリア -->
                <div id="abc-status" style="margin-top: 10px; color: gray;"></div>
            </div>
        </div>
    </div>

    <!-- Flaskから渡されたプリセットをJavaScriptで扱えるようにする -->
    <script>
        const presetsJsonString = '{{ presets | tojson | safe }}';
        const PRESETS = JSON.parse(presetsJsonString);
    </script>
</body>
</html>