# 🎵 発想標語に対応する演奏見本生成システム

---

## 📄 概要

本システムは、音楽の「発想標語」（*Cantabile*, *Dolce*, *Maestoso*など）が演奏にどのような変化をもたらすかを、実際に聴いて体験できるWebアプリケーションです。

楽譜（MusicXML）と元の演奏（MIDI）をアップロードし、ブラウザ上でフレーズを選択して発想標語を選ぶだけで、加工前後の演奏を手軽に聴き比べることができます。

---

## ✨ 主な特徴

-   **ブラウザでの操作**
    -   特別なソフトをインストールすることなく、Webブラウザだけで全ての操作が完結します。

-   **楽譜の表示**
    -   アップロードしたMusicXMLファイルを解析し、ブラウザ上で見やすい楽譜を自動で表示します。
    -   楽譜上の音符を直接クリックして、表現を加えたいフレーズ範囲を直感的に指定できます。

-   **多彩な表現プリセット**
    -   *Cantabile*（歌うように）や*Appassionato*（情熱的に）など、様々な発想標語が演奏パラメータのプリセットとして用意されています。
    -   プリセットの値をベースに、各パラメータをリアルタイムで微調整することも可能です。

-   **楽譜への反映**
    -   楽譜への変更（ハイライトや記号の追加）は即座に反映されます。Undo/Redoも待たされることなくサクサク行えます。

-   **音源生成と進捗表示**
    -   時間のかかるMIDI加工やWAV生成は裏側で実行され、処理の進捗がパーセンテージで表示されるため、ストレスなく待つことができます。

-   **聴き比べ機能**
    -   「加工前の元の演奏」と「発想標語を適用した加工後の演奏」を、「選択したパートのみ」「全体のアンサンブル」のそれぞれのパターンで聴き比べることが可能です。

---

## 📁 ディレクトリ構成

本システムの主要なファイルと、プログラム実行時に自動生成されるフォルダの構成は以下の通りです。
```
music-expression/
│
├── app.py # Flaskアプリ本体（ルーティング・API処理）
├── midi_processor.py # MIDI加工・WAV生成ロジック
│
├── uploads/ # アップロードされたMusicXMLとMIDIが保存されます
│
├── output/ # 自動生成されるファイルの保存先
│ ├── musicxml/ # パートごとのMusicXML
│ ├── abc/ # 楽譜表示用のABC記譜法ファイル
│ ├── json/ # note_map.json (音符とTickの対応表)
│ ├── midi/ # 生成されたMIDIファイル
│ │ ├── single_parts/ # 単一パート
│ │ │ ├── original/ # 加工前
│ │ │ └── processed/ # 加工後
│ │ └── full_parts/ # 全パート
│ │ ├── original/
│ │ └── processed/
│ └── audio/ # 生成されたWAV音声ファイル
│ ├── single_parts/
│ └── full_parts/
│
├── static/ # Webフロントエンド用の静的ファイル
│ ├── css/style.css
│ └── js/
│ ├── main.js # フロントエンドのメインロジック
│ └── abcjs-basic-min.js # 楽譜描画ライブラリ
│
├── templates/
│ └── index.html # メインページのHTMLテンプレート
│
├── soundfonts/
│ └── FluidR3_GM.sf2 # MIDIをWAVに変換するための音源ファイル
│
└── requirements.txt # Pythonの依存ライブラリリスト
```
---

## ⚙️ 環境構築手順（Windows）

本システムをローカル環境で動作させるための手順です。
**Visual Studio Code (VS Code)** と、以下の拡張機能がインストールされていることを前提としています。

-   Python
-   Pylance

### ① 仮想環境の作成

プロジェクトフォルダのルートディレクトリでターミナルを開き、以下のコマンドを実行して仮想環境を作成します。

```bash
python -m venv .venv
```

### ② 仮想環境の有効化

VS Codeでターミナルを開いた際に、仮想環境が自動で有効化されるように設定することを推奨します。

1.  コマンドパレットを開きます (`Ctrl + Shift + P`)
2.  「`Python: インタープリターの選択`」を選びます。
3.  リストから、先ほど作成した仮想環境のPython実行ファイル (`.\.venv\Scripts\python.exe`など) を選択します。

これにより、次回以降VS Codeでターミナルを開くと、自動的に `(.venv)` が先頭に表示され、仮想環境が有効化された状態になります。

### ③ 必要ライブラリのインストール

仮想環境が有効化されたターミナルで、以下のコマンドを実行します。

```bash
pip install -r requirements.txt
```

### ④FluidSynthの導入
MIDIファイルをWAV音声に変換するために必要なツールです。
1. 本リポジトリに含まれる ```fluidsynth``` フォルダをダウンロードします。
2. ダウンロードした ```fluidsynth``` フォルダを、**自分のPCの**```C:\tools\``` ディレクトリ内に配置します。
（最終的に ```C:\tools\fluidsynth\bin\fluidsynth.exe``` というパスになるようにしてください。```tools```フォルダがない場合は作成してください。）
3. Windowsの環境変数 Path に、以下のパスを追加します。
```bash
C:\tools\fluidsynth\bin
```

## 🚀 実行と使用方法

### アプリケーションの起動

1.  VS Codeのターミナル（仮想環境が有効化されている状態）で、以下のコマンドを実行します。
    ```bash
    flask run
    ```
2.  ターミナルに表示されるURL (`http://127.0.0.1:5000` など) を `Ctrl + クリック` してブラウザで開きます。

### 操作フロー

1.  **ファイル読み込み**
    -   「楽譜 (MusicXML)」と「演奏データ (MIDI)」のそれぞれに対応するファイルを選択します。
    -   ```[読み込み開始]``` ボタンをクリックします。
    -   (テスト時)各データはtestフォルダ内に格納してあります。好きな楽曲を使用してください。
2.  **パート選択**
    -   読み込みが完了すると、パート選択のドロップダウンが有効になります。
    -   楽譜を表示したいパートを選択すると、右側に楽譜が表示されます。
3.  **フレーズ選択**
    -   楽譜上の音符を「**開始**」→「**終了**」→「**頂点**」の順番でクリックします。
    -   順番が少し分かりづらいかもしれません🙇‍♀️
    -   フレーズの終了音符をクリックすると、頂点の候補となる音符が<span style="color: gold;">黄色</span>で表示されます。選んだフレーズによっては頂点候補の音符が複数表示されることがあります。
    -   頂点候補(黄色の音符)から頂点の音符を選ぶか、それ以外の音符(候補とは違うところを頂点にしたい場合)を選んでください。
    -   音符はそれぞれ、開始：<span style="color: red;">赤</span>、終了：<span style="color: blue;">青</span>、頂点：<span style="color: green;">緑</span>にハイライトされます。
4.  **表現プリセット選択**
    -   適用したい発想標語をドロップダウンから選択します。
    -   (テスト時)```[パラメータ調整]```ボタンを押すと、選択したプリセットの数値を手動で調整できます。
5.  **楽譜へ反映**
    -   ```[楽譜へ反映]``` ボタンをクリックします。選択したフレーズにハイライトと発想標語が追加されます。
    -   この操作はすぐ反映され、```[一つ前に戻る (Undo)]``` や ```[やり直す (Redo)]``` も行えます。
6.  **音源を生成**
    -   ```[音源を生成]``` ボタンをクリックします。これまでの操作履歴をすべて反映したMIDIとWAVファイルの生成がバックグラウンドで開始されます。
    -   進捗バーが表示され、完了すると聴き比べエリアが有効になります。
7.  **試聴と比較**
    -   聴き比べエリアの各再生ボタンを使い、加工前後の音源を比較試聴できます。

---

## 🔊 出力ファイルの構成

システムの使用中に `output` フォルダ内に自動生成されるファイルの役割は以下の通りです。

| 種別     | 保存先                               | 説明                               |
| :------- | :----------------------------------- | :--------------------------------- |
| 加工前MIDI | `output/midi/single_parts/original/` | 元のMIDIから抽出した単一パート       |
| 加工後MIDI | `output/midi/single_parts/processed/`  | 発想標語を適用した単一パート       |
| WAV音声  | `output/audio/...`                   | FluidSynthで生成された音声ファイル |
| note_map | `output/json/...`                    | 音符とMIDI tickの対応情報        |
| ABC譜面  | `output/abc/...`                     | ブラウザで楽譜を表示するためのデータ |
